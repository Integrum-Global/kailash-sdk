[pytest]
# Test discovery patterns
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
pythonpath = src
norecursedirs = apps sdk-users .git .tox dist build *.egg

# Markers for test categorization
# Tests are organized by directory: tests/unit/, tests/integration/, tests/e2e/
markers =
    # Tier markers (automatically applied based on directory)
    unit: Unit tests (fast, isolated) - tests/unit/
    integration: Integration tests (component interactions) - tests/integration/
    e2e: End-to-end tests (complete scenarios) - tests/e2e/

    # Priority markers (optional)
    critical: Core functionality tests (must always pass)
    smoke: Smoke tests (basic functionality check)
    regression: Regression tests for previously fixed bugs

    # Dependency markers
    slow: Slow running tests (30+ min)
    requires_docker: Tests requiring Docker services
    requires_postgres: Tests requiring PostgreSQL
    requires_mysql: Tests requiring MySQL
    requires_redis: Tests requiring Redis
    requires_ollama: Tests requiring Ollama LLM service

    # Other markers
    performance: Performance benchmark tests
    flaky: Tests that are known to be flaky
    asyncio: marks async tests that require asyncio
    docker: Tests requiring Docker infrastructure (deprecated - use requires_docker)
    ollama: Tests requiring Ollama LLM service (deprecated - use requires_ollama)
    ai: Tests involving AI/LLM functionality
    data_intensive: Tests with large datasets or heavy processing
    stress: Infrastructure stress tests
    benchmark: Performance benchmark tests
    requires_isolation: Tests that need process isolation due to mock state pollution
    endurance: Long-running endurance tests (hours or days)
    ci: Tests suitable for CI/CD pipelines (quick execution)

    # Tier markers for dataflow tests
    tier2: Integration tests with real database infrastructure
    tier3: Advanced E2E tests requiring full infrastructure

    # Infrastructure requirements
    requires_infrastructure: Tests requiring external infrastructure setup

# Environment-aware test options
addopts =
    --strict-markers
    --tb=short

# Enable asyncio auto mode for pytest-asyncio
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function
asyncio_default_test_loop_scope = function

# CI detection and optimization
[pytest:ci]
# CI-specific settings (activated when CI=true environment variable is set)
# Runs only Tier 1 tests (unit tests without external dependencies)
addopts =
    -x
    -q
    --capture=no
    --durations=10
    --strict-markers
    --disable-warnings
    --timeout=30
    tests/unit/
    -m "not (slow or integration or e2e or requires_docker or requires_postgres or requires_mysql or requires_redis or requires_ollama)"

[pytest:local]
# Local development settings (default)
addopts =
    -v
    --tb=short
    --maxfail=10

# Async test support
asyncio_mode = auto
asyncio_default_fixture_loop_scope = function

# Timeout for tests (seconds)
# Unit tests: 1 second max (target: < 100ms)
# Integration tests: 5 seconds max (target: 1-2 seconds)
# E2E tests: 10 seconds max (target: 3-5 seconds)
timeout = 10
timeout_method = thread

# Log settings (local only)
log_cli = true
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Warnings - Show all warnings for now so we can identify and fix them
filterwarnings =
    # Show warnings without converting to errors initially
    default
    # Ignore specific async coroutine warnings from test mocking infrastructure only
    ignore:coroutine.*was never awaited:RuntimeWarning
    # Ignore deprecated datetime warnings from compiled/dynamic code
    ignore:datetime.datetime.utcnow.*is deprecated:DeprecationWarning

# Coverage settings (when needed)
[coverage:run]
parallel = true
concurrency = multiprocessing
omit =
    */tests/*
    */conftest.py
    */__init__.py
    */setup.py

[coverage:report]
skip_covered = true
show_missing = false
precision = 0
