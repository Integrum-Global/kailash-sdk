events {
    worker_connections 1024;
}

http {
    upstream postgres {
        server postgres:5432;
    }

    upstream mongodb {
        server mongodb:27017;
    }

    upstream qdrant {
        server qdrant:6333;
    }

    upstream kafka {
        server kafka:9092;
    }

    upstream ollama {
        server ollama:11434;
    }

    upstream redis {
        server redis:6379;
    }

    upstream oauth2 {
        server mock-oauth2:8080;
    }

    server {
        listen 80;

        location /health {
            default_type application/json;
            return 200 '{"status": "healthy", "services": ["postgres", "mongodb", "qdrant", "kafka", "ollama", "redis", "oauth2"]}';
        }

        location /health/postgres {
            proxy_pass http://postgres/;
            proxy_connect_timeout 1s;
            proxy_read_timeout 1s;
        }

        location /health/qdrant {
            proxy_pass http://qdrant/health;
            proxy_connect_timeout 1s;
            proxy_read_timeout 1s;
        }

        location /health/ollama {
            proxy_pass http://ollama/api/version;
            proxy_connect_timeout 1s;
            proxy_read_timeout 1s;
        }

        location /health/redis {
            # Redis doesn't have HTTP endpoint, so we check if port is open
            return 200 '{"status": "check port 6379"}';
        }

        location /health/oauth2 {
            proxy_pass http://oauth2/default/.well-known/openid-configuration;
            proxy_connect_timeout 1s;
            proxy_read_timeout 1s;
        }

        location /health/kafka {
            # Kafka doesn't have a simple HTTP health endpoint
            return 200 '{"status": "check port 9092"}';
        }
    }
}
